---
title: TCP 简略笔记
date: 2020-11-24 15:06:03
tags: Computer Networking
hide: false
---

#### TCP与UDP的区别
- TCP是面向连接的， UDP是无连接的（只管发送）
- TCP是可靠的， UDP不可靠（UDP接收方收到报文后，不需要给出任何确认）
- TCP只支持点对点通信，UDP支持一对一、一对多、多对一、多对多；
- TCP是面向字节流的，UDP是面向报文的
  面向字节流是指发送数据时以字节为单位，一个数据包可以拆分成若干组进行发送，而UDP一个报文只能一次发完。
- TCP有拥塞控制机制，UDP没有。网络出现的拥塞不会使源主机的发送速率降低，这对某些实时应用是很重要的，比如媒体通信，游戏
- TCP Heaader开销（20字节）比UDP开销（8字节）要大
- UDP 的主机不需要维持复杂的连接状态表

#### 什么时候选择TCP，什么时候选UDP？
对某些实时性要求比较高的情况，选择UDP，比如游戏，媒体通信，实时视频流（直播），即使出现传输错误也可以容忍；其它大部分情况下，HTTP都是用TCP，因为要求传输的内容可靠，不出现丢失

#### TCP如何保证传输的可靠性

- 数据包校验
- 对失序数据包重新排序（TCP报文具有序列号）
- 丢弃重复数据
- 应答机制：接收方收到数据之后，会发送一个确认（通常延迟几分之一秒）；
- 超时重发：发送方发出数据之后，启动一个定时器，超时未收到接收方的确认，则重新发送这个数据；
- 流量控制：确保接收端能够接收发送方的数据而不会缓冲区溢出

#### TCP的流量控制（接收方原因）
如果接收方的读取速率远不及发送方的发送速率，接收方缓存很容易用光。

双方各自维护一个“接收窗口”的变量。用以表示空闲空间的大小，这个变量在动态改变。

如果接收方没有能力接收数据，就会将接收窗口设置为0，这时发送方必须暂停发送数据，但是会启动一个持续计时器(persistence timer)，到期后发送一个大小为1字节的探测数据包，以查看接收窗口状态。如果接收方能够接收数据，就会在返回的报文中更新接收窗口大小，恢复数据传送。

#### TCP的拥塞控制（网络原因）
tcp 的拥塞控制 是端到端的拥塞控制，而不是网络辅助的拥塞控制。因为ip层并不向端系统提供网拥塞反馈。

维护一个新变量，拥塞窗口。
发送方的流量速率不能超过 拥塞窗口 和 接收窗口 中的最小值

- 丢包意味着拥塞发生， 应降低发送速率
- ACK信号可以认为是正常到达接收方，可以增加发送方的速率
- 带宽检测。发送速率在正常时持续提高，直到发生拥塞，再降低继续探测。

- MSS Maximum Segment Size，最大报文段，收发双方协商通信时每一个报文段所能承载的最大数据长度
- RTT ，Round-Trip Time，往返时延

##### 慢启动（指数级增加）
先把拥塞窗口（congestion window）设置为一个最大报文段MSS的数值，每收到一个新的确认报文之后，就把拥塞窗口加1个MSS。这样每经过一个传输轮次（或者说是每经过一个往返时间RTT），拥塞窗口的大小就会加倍

直到发生掉包，设置拥塞窗口为1， 并且设置ssthresh (slow start threshold)为拥塞窗口的一半大小，重新开始慢启动
或者当窗口大小 接近 ssthresh时，进入拥塞避免阶段。
或者检测到三个 冗余的 ACK 进入快速恢复阶段

##### 拥塞避免（线性增长）
这个阶段是在试探上限。

即每经过一个传输轮次只增加1MSS

直到 超时、丢包，设置拥塞窗口为1MSS， 并且设置ssthresh (slow start threshold)为拥塞窗口的一半大小，重新开始慢启动


    

#### 快重传
快重传要求接收方在收到一个失序的报文段后就立即发出重复确认（为的是使发送方及早知道有报文段没有到达对方）而不要等到自己发送数据时捎带确认。快重传算法规定，发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段，而不必继续等待设置的重传计时器时间到期。

##### 快速恢复

当发送方连续收到三个重复确认时，就把慢开始门限ssthresh设置为 1/2 拥塞窗口，然后执行拥塞避免算法。

不执行慢开始算法的原因：因为如果网络出现拥塞的话就不会收到好几个重复的确认，所以发送方认为现在网络可能没有出现拥塞。

也有的快重传是把开始时的拥塞窗口cwnd值再增大一点，即等于 ssthresh + 3*MSS 。这样做的理由是：既然发送方收到三个重复的确认，就表明有三个分组已经离开了网络。这三个分组不再消耗网络的资源而是停留在接收方的缓存中。可见现在网络中减少了三个分组。因此可以适当把拥塞窗口扩大些。

另一种阐述：

1.当收到3个重复ACK时，把ssthresh设置为cwnd的一半，把cwnd设置为ssthresh的值加3，然后重传丢失的报文段，加3的原因是因为收到3个重复的ACK，表明有3个“老”的数据包离开了网络。

2.再收到重复的ACK时，拥塞窗口增加1。

3.当收到新的数据包的ACK时，把cwnd设置为第一步中的ssthresh的值。原因是因为该ACK确认了新的数据，说明从重复ACK时的数据都已收到，该恢复过程已经结束，可以回到恢复之前的状态了，也即再次进入拥塞避免状态。

#### 一些问题
- HTTP可以使用UDP吗？
HTTP不可以使用UDP，HTTP需要基于可靠的传输协议，而UDP不可靠



------
#### 参考
[TCP与UDP的区别](https://github.com/wolverinn/Waking-Up/blob/master/Computer%20Network.md#tcp%E4%B8%8Eudp%E7%9A%84%E5%8C%BA%E5%88%AB)
[TCP拥塞控制——快重传和快恢复] (https://blog.csdn.net/qq_36953135/article/details/77506009)