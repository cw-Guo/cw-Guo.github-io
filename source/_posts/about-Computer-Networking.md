---
title: TCP 的三次握手和四次挥手
date: 2020-11-24 14:07:26
tags: Computer Networking, Interview
hide: true
---
这是一份关于计算机网络的面试向准备笔记
#### TCP
TCP是一种面向连接的单播协议。
所谓连接，即双方各自保存一份对方的信息，如ip地址，端口等等。
可靠的、面向连接的、字节流、传输层的协议

TCP 采用三次握手建立连接，四次挥手断开连接。

#### 一些概念
- ACK acknowledge
  当TCP接收到另一端的数据时，它会发送一个确认，但这个确认不会立即发送，一般会延迟一会儿。ACK是累积的，一个确认字节号N的ACK表示所有直到N的字节（不包括N）已经成功被接收了。这样的好处是如果一个ACK丢失，很可能后续的ACK就足以确认前面的报文段了。
  
- ACK —— 确认，使得确认号有效。 
- RST —— 重置连接（经常看到的reset by peer）就是此字段搞的鬼。 
- SYN —— 用于初如化一个连接的序列号。 
- FIN —— 该报文段的发送方已经结束向对方发送数据。
- ISN —— Initial Sequence Number

一个完整的TCP连接是双向和对称的，数据可以在两个方向上平等地流动。

#### 具体实现
##### 三次握手 - 建立连接
- 客户端发送一个SYN段，并指明客户端的初始序列号
- 服务端发送自己的SYN段作为应答，为了确认客户端的SYN，将ISN(c)+1作为ACK数值
- 为了确认服务器端的SYN，客户端将ISN(s)+1作为返回的ACK数值。
![三次握手](../images/three_way.png)

##### 四次挥手 - 断开连接
- 客户端发送一个FIN段，并包含一个希望接收者看到的自己当前的序列号K. 同时还包含一个ACK表示确认对方最近一次发过来的数据。
- 服务端将K值加1作为ACK序号值，表明收到了上一个包。这时上层的应用程序会被告知另一端发起了关闭操作，通常这将引起应用程序发起自己的关闭操作。
- 服务端发起自己的FIN段，ACK=K+1, Seq=L
- 客户端确认。ACK=L+1

![四次挥手](../images/four_way.png)
#### why 三次握手和四次挥手
- 三次握手
 简言之，是为了判断双方的接收和发送能力都正常从而建立正常的连接。
 每个端只能知道自己成功发送/或接收数据，并不能知道对方的情况，所以需要三次握手确认连接正常建立。
 
 其实每次收到网络包的一方至少是可以得到：对方的发送、我方的接收是正常的。

- 四次挥手
 TCP连接是双向传输的对等的模式，就是说双方都可以同时向对方发送或接收数据。当有一方要关闭连接时，会发送指令告知对方，我要关闭连接了。这时对方会回一个ACK，此时一个方向的连接关闭。但是另一个方向仍然可以继续传输数据，等到发送完了所有的数据后，会发送一个FIN段来关闭此方向上的连接。接收方发送ACK确认关闭连接。注意，接收到FIN报文的一方只能回复一个ACK, 它是无法马上返回对方一个FIN报文段的，因为结束数据传输的“指令”是上层应用层给出的。



-----
#### 参考
“三次握手，四次挥手”你真的懂吗？ https://zhuanlan.zhihu.com/p/53374516
“计算机网络” https://github.com/wolverinn/Waking-Up/blob/master/Computer%20Network.md#%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C